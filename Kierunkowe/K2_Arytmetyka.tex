\sloppy\section{K2 -- Arytmetyka stało- i zmiennoprzecinkowa}

Ludzie spodziewają się, że komputery będą dokładne i nieomylne.
Spodziewają się, że po wpisaniu 0.1 + 0.2 kalkulator odpowie: 0.3.

Prędzej czy później każdy programista próbuje czegoś takiego i natrafia na problem: komputer twierdzi, że wynik tego dodawania to np. 0.30000001.
Skąd takie rzeczy?


Każda informacja w komputerze jest przedstawiona za pomocą podstawowych jednostek -- bitów. W przypadku liczb, można je reprezentować za pomocą typów \{stało-,zmienno-\}przecinkowych. Różnią się cechami takimi jak:
\begin{itemize}
\item sposób zapisu,
\item zakres wartości,
\item precyzja operacji.
\end{itemize}

Typy stałoprzecinkowe posiadają wiele reprezentacji. 

\subsection{Naturalny kod binarny (NBC)}
Jest to system pozycyjny o podstawie 2. Liczby zapisane w tej reprezentacji nie posiadają znaku, nie można za jego pomocą zapisać ułamków. Wartość liczby można zaprezentować za pomocą wzoru (liczba \textit{n-bitowa}):
\begin{equation}
x = \sum_{i=0}^{n-1}2^{i} \times x_{i}
\end{equation}
Na przykład:
\begin{table}[H]
\centering
\begin{tabular}{|c|c|} \hline
DEC	&	BIN (NKB)	\\ \hline
0	&	00	\\ \hline
1	&	01	\\ \hline
2	&	10	\\ \hline
3	&	11	\\ \hline
\end{tabular}
\end{table}

\subsection{Kod uzupełnieniowy U2}
W celu reprezentacji liczby całkowitej potrzebne jest zdefiniowanie znaku liczby. Wartość liczb zapisuje się podobnie jak w wypadku NKB, jednak znak liczby jest określony przez bit najbardziej znaczący (0 -- liczba dodatnia, 1 -- liczba ujemna).
Aby otrzymać wartość n-bitowej liczby zapisanej w kodzie U2 można skorzystać z następującego wzoru:
\begin{equation}
x = (-1)^{n-1}+\sum_{i=0}^{n-2}2^{i} \times x_{i}
\end{equation}

Jak wynika ze wzoru, o ile liczba dodatnia wygląda tak samo jak w NKB, to postać liczby ujemnej zapisanej w U2 wcale nie jest taka sama jak w NKB z dodaną jedynką na przodzie.

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|} \hline
DEC	&	NKB		&	U2	\\ \hline
-3	&	---		&	101\\ \hline
-2	&	---		&	110\\ \hline
-1	&	---		&	111\\ \hline
0	&	000		&	000\\ \hline
1	&	001		&	001\\ \hline
2	&	010		&	010\\ \hline
3	&	011		&	011\\ \hline
\end{tabular}
\end{table}

Dwa łatwe sposoby na odczytanie wartości liczby ujemnej w U2:
\begin{itemize}
	\item{Neguj wszystkie bity i dodaj 1.}
	\item{Potraktuj najstarszy bit jak ujemną wartość na tej pozycji i dodaj do niej pozostałe bity.}
\end{itemize}

W dwójkowym systemie uzupełnieniowym porządek kodów arytmetycznych jest zachowany w całym zakresie. $\{0, x_{n-2},\ldots,x_{1},x_{0}\}$ reprezentuje dodatnią liczbę $x$, a $\{1, x_{n-2},\ldots,x_{1},x_{0}\}$ to zapis liczby \textbf{większej o $x$ od najmniejszej liczby $-2^{n-1}$}.

Podobnie jak dla NKB, nie jest możliwe zastosowanie tutaj zapisu ułamków.

\subsection{Typ stałoprzecinkowy}
Reprezentacja ta jest podobna do kodu uzupełnieniowego, jednakże można tutaj określić pozycję przecinka. Dla liczb o podstawie $\beta$ oraz ustalonej liczbie pozycji części ułamkowej -- $r$, wartość każdej liczby jest podana z dokładnością $\beta^{-r}$. Można ją przedstawić za pomocą iloczynu liczby całkowitej, wtedy zapis wygląda następująco:
\begin{equation}
\{x_{m},x_{m-1},\ldots,x_{1},x_{0},\ldots,x_{-r}\}
\end{equation}

Podczas operacji z liczbami stałoprzecinkowymi można otrzymać przeniesienie w wypadku operacji dodawania lub mnożenia.

\subsection{Inne systemy stałoprzecinkowe}
\begin{itemize}
\item system obciążony,
\begin{itemize}
\item[+] unikatowa reprezentacja zera,
\item[+] zgodność uporządkowania liczb i ich reprezentacji,
\item[-] wymagana korekcja wyników działań arytmetycznych,
\item[-] problematyczne przy dzieleniu i mnożeniu.
\end{itemize}
\item system ze znakowaną cyfrą.
\end{itemize}

\subsection{Typ zmiennoprzecinkowy}
Przedstawione do tej pory systemy były \textbf{stało}przecinkowe.
Znaczy to tyle, że miały z góry określoną precyzję i rozmiar.

Jedną z wad typów stałoprzecinkowych jest ilość miejsca potrzebna do przechowywania liczb: aby przechować liczbę z zakresu <0; 4,294,967,295> potrzebujemy aż 32 bitów pamięci.

Wyobraźmy sobie, że potrzebne nam są liczby rzędu rozmiaru wszechświata albo wielkości atomu.

Gdybyśmy takie liczby chcieli zapisać w typie stałoprzecinkowym to musielibyśmy zmarnować ogromne ilości pamięci na przechowywanie zer.

Rozwiązanie? Notacja naukowa i zmienny przecinek.

Liczba zmiennoprzecinkowa jest reprezentowana przez 4 liczby ($S$, $\beta$, $M$, $E$):
\begin{itemize}
\item $S$ -- znak,
\item $\beta$ -- podstawa,
\item $E$ -- wykładnik,
\item $M$ -- mantysa.
\end{itemize}
\begin{equation}
x = (-1)^{S} \times \beta^{E} \times M
\end{equation}

Łatwo zauważyć, że jest to po prostu notacja naukowa, lecz jak tak właściwie taka liczba wygląda?

Pierwszy bit jest bitem znaku -- 0 dla liczb dodatnich i 1 dla liczb ujemnych. Tak jest zawsze.

Kolejne bity to bity wykładnika i to ile tych bitów jest zależy od typu (precyzji).
Dla liczby pojedynczej precyzji, czyli typu 32-bitowego, liczba bitów wykładnika wynosi 8.

\textbf{Ważne:} wykładnik jest zapisany w systemie obciążonym +N ($N = 2^{k-1}-1$, gdzie k to liczba bitów wykładnika) -- dla 32-bitowej liczby jest to system +127.

Pozostałe bity to liczby części ułamkowej.
Ważne jest tutaj pojęcie liczby znormalizowanej, czyli takiej, dla której przyjmujemy, że część ułamkowa ma na początku ukrytą jedynkę -- jest więc postaci 1.xxx, a nie 0.xxx.
Więcej o tym za chwilę.

Przykład:
Liczba 17 zapisana jako 32-bitowa liczba zmiennoprzecinkowa ma postać:

0|10000011|00010000000000000000000

czyli

\begin{itemize}
	\item{Znak -- 0 -> liczba dodatnia}
	\item{Wykładnik -- $10000011 == 2^{131 - 127} == 2^4$}
	\item{Mantysa -- $00010000000000000000000 == 1.0625$}
\end{itemize}

Po złożeniu wychodzi nam:
$(-1)^0 * 2^4 * 1.0625 == 1 * 16 * 1.0625 == 17.0$

Jaka jest główna zaleta takiego zapisu?
Ogromny wręcz zakres wartości możliwych do zapisania: korzystając z 32-bitowego typu zmiennoprzecinkowego możemy zapisać wartości z oszałamiającego zakresu <1.17549435082228750796874e-38, 3.40282346638528859811704e+38>.

Kilka bardzo ważnych faktów:

W przypadku liczb zmiennoprzecinkowych ważna jest kolejność działań!

Liczby zmiennoprzecinkowe zawierają zarezerwowane wartości dla liczb specjalnych.

Standard IEEE754 wymaga, aby liczby były znormalizowane (oprócz wartości specjalnych). Standard wymaga również, aby mantysa była w zakresie $1 \le |M| < 2$. Dzięki temu można ukryć najwyższy bit (mantysa jest postaci $1.bbb\ldots bb$).

Jeśli liczba jest ujemna, to jej pierwszy bit (znaku) przyjmuje wartość 1, w wypadku dodatniej 0. Kolejne bity przypadają na wykładnik w kodzie +N ($N = 2^{k-1}-1$), kolejnymi bitami jest mantysa. Nigdy nie będzie ona równa 0. Przyjęto, że zero oprócz bitu znaku zawiera same zera (tak więc mamy tu zero dodatnie i ujemne). $\pm\infty$ -- wszystkie bity wykładnika wynoszą 1, mantysa 0. Dla nie-liczb wykładnik również przyjmie same jedynki, natomiast mantysę $\ne$ 0.

Liczby zdenormalizowane posiadają w wykładniku same zera, natomiast mantysa jest postaci $0.bbb\ldots bb$.

\begin{table}[H]
\centering
\caption{Liczba zmiennoprzecinkowa pojedynczej precyzji (32 bity)}
\footnotesize
\addtolength{\tabcolsep}{-4.75pt}
\begin{tabular}{ccccccccccccccccccccccccccccccccc}
\rotatebox[origin=c]{90}{Bit}                     &                        &                        &                        &                        &                        &                        &                         &                        &                        &                        &                        &                        &                        &                        &                         &                        &                        &                        & & & & & & & & & & & & & &           \\
\multicolumn{1}{|l}{31} &                        &                        &                        &                        &                        &                        & \multicolumn{1}{l|}{24} & 23                     &                        &                        &                        &                        &                        &                        & \multicolumn{1}{l|}{16} & 15                     &                        &                        & & & & & \multicolumn{1}{l|}{8} & 7 & & & & & & & & \multicolumn{1}{c|}{0}              \\ \hline
\multicolumn{1}{|c|}{\cellcolor{red!75}S} & \multicolumn{1}{c|}{\cellcolor{yellow!75}E} & \multicolumn{1}{c|}{\cellcolor{yellow!75}E} & \multicolumn{1}{c|}{\cellcolor{yellow!75}E} & \multicolumn{1}{c|}{\cellcolor{yellow!75}E} & \multicolumn{1}{c|}{\cellcolor{yellow!75}E} & \multicolumn{1}{c|}{\cellcolor{yellow!75}E} & \multicolumn{1}{c|}{\cellcolor{yellow!75}E}  & \multicolumn{1}{c|}{\cellcolor{yellow!75}E} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M}  & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} & \multicolumn{1}{c|}{\cellcolor{green!75}M} \\ \hline
\rotatebox[origin=c]{90}{Znak~}                        & \rotatebox[origin=c]{90}{Wykładnik~}                       &                        &                        &                        &                        &                        &                         &                        & \rotatebox[origin=c]{90}{Mantysa~}                       &                        &                        &                        &                        &                        &                         &                        &                        &                        &                       
\end{tabular}
\normalsize
\end{table}

\begin{table}[H]
\centering
\caption{Liczby w standardzie IEEE754}
\begin{tabular}{|c|c|c|c|}
\hline
\textbf{Znak} & \textbf{Wykładnik} & \textbf{Mantysa} & \textbf{Wartość} \\ \hline
0 & $00\cdots00$ & $00\cdots00$ & $+0$ \\ \hline
0 & $00\cdots00$ & \begin{tabular}[c]{@{}c@{}}$00\cdots01$\\$\vdots$\\$11\cdots11$\end{tabular} & \begin{tabular}[c]{@{}c@{}}Dodatnia zdenormalizowana\\($0.f\times 2^{-N+1}$)\end{tabular} \\ \hline
0 & \begin{tabular}[c]{@{}c@{}}$00\cdots01$\\$\vdots$\\$11\cdots10$\end{tabular} & XX$\cdots$XX & \begin{tabular}[c]{@{}c@{}}Dodatnia znormalizowana\\($1.f\times 2^{E-N}$)\end{tabular} \\ \hline
0 & $11\cdots11$ & $00\cdots00$ & $+\infty$ \\ \hline
0 & $11\cdots11$ & \begin{tabular}[c]{@{}c@{}}$00\cdots01$\\$\vdots$\\$01\cdots11$\end{tabular} & SNaN \\ \hline
0 & $11\cdots11$ & 1X$\cdots$XX & QNaN \\ \hline
1 & $00\cdots00$ & $00\cdots00$ & $-0$ \\ \hline
1 & $00\cdots00$ & \begin{tabular}[c]{@{}c@{}}$00\cdots01$\\$\vdots$\\$11\cdots11$\end{tabular} & \begin{tabular}[c]{@{}c@{}}Ujemna zdenormalizowana\\($-0.f\times 2^{-N+1}$)\end{tabular} \\ \hline
1 & \begin{tabular}[c]{@{}c@{}}$00\cdots01$\\$\vdots$\\$11\cdots10$\end{tabular} & XX$\cdots$XX & \begin{tabular}[c]{@{}c@{}}Ujemna znormalizowana\\($-1.f\times 2^{E-N}$)\end{tabular} \\ \hline
1 & $11\cdots11$ & $00\cdots00$ & $-\infty$ \\ \hline
1 & $11\cdots11$ & \begin{tabular}[c]{@{}c@{}}$00\cdots01$\\$\vdots$\\$01\cdots11$\end{tabular} & SNaN \\ \hline
1 & $11\cdots11$ & 1X$\cdots$XX & QNaN \\ \hline
\end{tabular}
\end{table}
N -- obciążenie wykładnika, X -- dowolna wartość.

\begin{table}[H]
\centering
\caption{Specjalne operacje arytmetyczne}
\begin{tabular}{|c|c|}
\hline
\textbf{Operacja} & \textbf{Wynik} \\ \hline
$\frac{n}{\pm\infty}$ & 0  \\ \hline
$\pm\infty\times\pm\infty$ & $\pm\infty$  \\ \hline
$\frac{\pm X}{0}$ & $\pm\infty$  \\ \hline
$X\times\pm\infty$ & $\pm\infty$  \\ \hline
\begin{tabular}[c]{@{}c@{}}$\infty+\infty$\\$\infty- -\infty$\end{tabular} & $+\infty$  \\ \hline
\begin{tabular}[c]{@{}c@{}}$-\infty-\infty$\\$-\infty+ -\infty$\end{tabular} & $-\infty$  \\ \hline
\begin{tabular}[c]{@{}c@{}}$\infty-\infty$\\$-\infty+ \infty$\end{tabular} & NaN \\ \hline
$\frac{\pm 0}{\pm 0}$ & NaN \\ \hline
$\frac{\pm\infty}{\pm\infty}$ & NaN \\ \hline
$\infty\pm 0$ & NaN \\ \hline
\end{tabular}
\end{table}

Standard wyróżnia następujące precyzje:
\begin{itemize}
\item połowicza (16 bit),
\item pojedyncza (32 bit),
\item podwójna (64 bit),
\item podwójna rozszerzona (80 bit).
\end{itemize}

Standard również wyróżnia wyjątki:
\begin{itemize}
\item invalid operation --- niewłaściwa operacja,
\item division by zero --- dzielenie przez zero,
\item overflow --- nadmiar -- liczba jest za duża,
\item underflow --- niedomiar -- utrata precyzji przy liczbach bliskich zero,
\item inexact --- niedokładność -- podczas operacji zaokrąglania.
\end{itemize}

\subsection{Działania}
\subsubsection{Arytmetyka stałoprzecinkowa}
\begin{itemize}
\item \textbf{Dodawanie/odejmowanie}
	\begin{itemize}
	\item dodawanie kolejnych cyfr, z zachowaniem ich pozycji
	\item występują przeniesienia
	\item odejmowanie -- dodawanie liczby przeciwnej (odjętej od zera)
	\end{itemize}
\item \textbf{Mnożenie}
	\begin{itemize}
	\item mnożenie mnożnej kolejnymi cyframi mnożnika, potem dodanie kolejnych sum częściowych
	\item w systemie uzupełnieniowym jest podobnie jak w naturalnym, gdy mnożnik ujemny wymagana jest korekcja wyniku
	\end{itemize}
\item \textbf{Dzielenie}
	\begin{itemize}
	\item wynik dzielenia jest przybliżony (nie ma gwarancji, że dla dzielnej $X$ oraz dzielnika $D$ istnieje liczba $Q$, że $X = Q * D$, można to skorygować dodając resztę z dzielenia)
	\item właśnie ogarnąłem, że opisałem fakty, których uczyliśmy się w podstawówce
	\end{itemize}
\end{itemize}

\subsubsection{Arytmetyka zmiennoprzecinkowa}
\begin{itemize}
\item \textbf{Dodawanie/odejmowanie}
	\begin{itemize}
	\item wymaga wyrównania wykładników (mniejszy do większego)
	\item denormalizacja jednej liczby, następnie dodanie/odjęcie mantys, potem normalizacja wyniku
	\item nadmiar/niedomiar może wystąpić przy normalizacji
	\end{itemize}
\item \textbf{Mnożenie/dzielenie}
	\begin{itemize}
	\item mnożenie -- przemnożenie mantys, dodanie wykładników, normalizacja
	\item dzielenie -- podzielenie mantys, odjęcie wykładników, normalizacja
	\item może wystąpić nadmiar/niedomiar
	\end{itemize}
\end{itemize}

\subsection{Podsumowanie}
\begin{table}[H]
\centering
\begin{tabular}{|l|l|l|}
\hline
\multicolumn{1}{|c|}{\textbf{Cecha}}                          & \multicolumn{1}{c|}{\textbf{L. stałoprzecinkowe}}                                               & \multicolumn{1}{c|}{\textbf{L.zmiennoprzecinkowe}}                                                             \\ \hline
Reprezentacja                                                 & \begin{tabular}[c]{@{}l@{}}Tak jak w systemie \\ pozycyjnym lub \\ uzupełnieniowym\end{tabular} & \begin{tabular}[c]{@{}l@{}}Reprezentacja przez:\\ znak, wykładnik, mantysę\end{tabular}                        \\ \hline
Dokładność                                                    & \begin{tabular}[c]{@{}l@{}}Mały zakres, \\ dokładne wyniki\end{tabular}                         & \begin{tabular}[c]{@{}l@{}}Duży zakres, możliwe \\ zaokrąglenia, utrata precyzji\end{tabular}                  \\ \hline
\begin{tabular}[c]{@{}l@{}}Obsługa \\ błędów\end{tabular}     & \begin{tabular}[c]{@{}l@{}}Może wystąpić \\ przepełnienie\end{tabular}                          & \begin{tabular}[c]{@{}l@{}}Zaokrąglenia, błędne operacje, \\ przepełnienie, niedomiar\end{tabular}             \\ \hline
\begin{tabular}[c]{@{}l@{}}Wartości \\ specjalne\end{tabular} & \multicolumn{1}{c|}{---}                                                                        & \begin{tabular}[c]{@{}l@{}}+0, -0, $+\infty$, $-\infty$,\\ QNaN, SNaN, liczby \\ zdenormalizowane\end{tabular} \\ \hline
Arytmetyka                                                    & \begin{tabular}[c]{@{}l@{}}Wszystkie twierdzenia \\ prawdziwe\end{tabular}                      & \begin{tabular}[c]{@{}l@{}}Kolejność działań \\ wpływa na wynik\end{tabular}                                   \\ \hline
\end{tabular}
\end{table}